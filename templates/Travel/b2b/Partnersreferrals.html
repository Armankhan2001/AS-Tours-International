<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Partner Referrals | ASTours International</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">


    <style>
        /* --- Tailwind Variables Setup --- */
        :root {
            --navy: #07203a; /* Deep Navy Blue */
            --gold: #d4af37; /* Premium Gold */
            --primary-blue: #0d6efd; /* Bootstrap Primary */
            --light-bg: #f8f9fa;
        }

        /* --- Global & Dashboard Styles (Bootstrap + Custom) --- */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #e0f2ff, #ffffff);
            color: #333;
            min-height: 100vh;
        }

        /* Premium CTA button */
        .btn-gold {
            background: linear-gradient(90deg, var(--gold), #f3d27a);
            color: var(--navy);
            font-weight: 600;
            font-size: 0.875rem; 
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1.25rem;
            border-radius: 9999px;
        }

        .btn-gold:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
            color: var(--navy);
        }

        /* Logo badge style (Non-rounded as requested) */
        .logo-badge {
            height: 140px; 
            width: 140px;
            background-color: #ffd700;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            /* border-radius: 0px; **Ensuring it's not rounded** */
            /* position: absolute; */
            top: -20px; 
            left: 10px;
            z-index: 100;
        }
        .logo-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
        }

        .logo-badge img {
            width: 90%;
            height: auto;
            padding: 4px;
        }

        /* Navbar link font size */
        .nav-link {
            font-size: 0.875rem;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        /* Header Styles */
        .header {
            text-align: center;
            padding: 90px 15px 30px; 
            background: linear-gradient(to right, #ffffff, #f0f4f8);
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        .header h1 {
            font-family: 'Playfair Display', serif;
            font-weight: 900;
            color: var(--navy); 
            font-size: 2.5rem;
        }
        .header p {
            color: #555;
            font-size: 1.1rem;
        }

        /* Card & Input Styles */
        .card {
            border: 1px solid #e9ecef;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            background: #fff;
        }
        .form-control {
            border-radius: 10px;
            padding: 0.65rem 1rem;
        }
        .btn-primary {
            background-color: var(--primary-blue);
            border-color: var(--primary-blue);
            font-weight: 600;
            padding: 0.6rem 1.75rem;
            border-radius: 10px;
        }
        .btn-primary:hover {
            background-color: #0b5ed7;
            border-color: #0b5ed7;
        }

        /* Discount Box */
        .discount-box {
            background: linear-gradient(135deg, #17a2b8, #1abc9c);
            color: white;
            padding: 30px;
            border-radius: 18px;
            text-align: center;
            box-shadow: 0 6px 15px rgba(0,0,0,0.25);
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Table Styles */
        .table {
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid #dee2e6;
        }
        .table-light th {
            background-color: #e9ecef;
            color: var(--navy);
            font-weight: 600;
            border-color: #dee2e6;
        }
        
        /* Loading & Spinner */
        #loading {
            display: none;
            text-align: center;
            padding: 25px;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px 10px;
            color: #777;
            font-size: 14px;
            background-color: #fff;
            border-top: 1px solid #ddd;
        }
    </style>
</head>

<body class="antialiased">
    <header class="relative top-0 z-50 bg-white/95 backdrop-blur-md shadow-sm">
        <div class="max-w-7xl mx-auto px-4 lg:px-8">
            <div class="flex items-center justify-between h-20"> 
                <div class="absolute top-0 left-4 z-50">
                    <a href="../../../index.html" class="logo-badge" style="top: -20px; left: 10px;"> 
                        <img src="../../../image/astourlogo.png" alt="AS Tours International">
                    </a>
                </div>

                <div class="w-36 flex-shrink-0"></div>

                <nav class="hidden lg:flex items-center gap-6 text-[var(--navy)]">
                    <a href="#" class="nav-link text-[var(--gold)] border-b-2 border-[var(--gold) ]">Home</a>
                    <a href="b2b.html" class="nav-link hover:text-[var(--gold)]">Other B2B Services</a>
                    <a href="../../contact.html" class="nav-link hover:text-[var(--gold)]">Contact</a>
                    <a href="Visa/b2b.html" class="ml-4 btn-gold">Partner with Us</a>
                </nav>

                <div class="lg:hidden ml-auto">
                    <button id="mobileBtn" class="p-2 rounded-md hover:bg-gray-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-[var(--navy)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                </div>

            </div>
        </div>

        <div id="mobileMenu" class="hidden lg:hidden bg-white border-t border-gray-200 w-full">
            <div class="px-6 py-4 space-y-3 text-[var(--navy)] font-medium">
                <br>
                <br>
                <a href="#" class="nav-link text-[var(--gold)] border-b-2 border-[var(--gold) ]">Home</a>
                <a href="b2b.html" class="nav-link hover:text-[var(--gold)]">Other B2B Services</a>
                <a href="../../contact.html" class="nav-link hover:text-[var(--gold)]">Contact</a>
                <a href="Visa/b2b.html" class="ml-4 btn-gold">Partner with Us</a>
            </div>
        </div>
    </header>
    <section class="header">
        <h1>ü§ù Partner Referral Dashboard</h1>
        <p>Track all clients referred by your company and enjoy exclusive 50% B2B partner discounts.</p>
    </section>

    <div class="container pb-5">
        <div class="card p-5">
            <h4 class="text-center mb-4 text-xl font-bold text-gray-700">Access Your Referral Data</h4>
            <div class="row g-3 justify-content-center mb-4">
                <div class="col-md-5">
                    <label for="clientId" class="form-label fw-semibold">Enter Your Partner ID</label>
                    <input type="text" id="clientId" class="form-control" placeholder="e.g. 11025">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-primary px-4 w-100" onclick="fetchReferral()">
                        <i class="fas fa-search me-2"></i> Show My Referrals
                    </button>
                </div>
            </div>
            
            <hr class="my-5">

            <div id="loading">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Loading your referral data, please wait...</p>
            </div>

            <div id="resultSection" style="display:none;">
                <div class="discount-box">
                    <h5>üéÅ Exclusive 50% B2B Partner Discount</h5>
                    <p class="mb-0">
                        We provide **50% discounted rates** for all clients who connect through you ‚Äî whether via referrals, social media, or direct mentions of your company name. Your genuine client data is displayed below.
                    </p>
                </div>

                <div class="row mb-4 align-items-center">
                    <div class="col-md-8">
                        <h5 class="fw-bold text-secondary mb-2"><i class="fas fa-user-tie me-2"></i>Partner Information</h5>
                        <p class="mb-1"><strong>Client ID:</strong> <span class="badge bg-primary fs-6" id="clientIdDisplay"></span></p>
                        <p class="mb-1"><strong>Company Name:</strong> <span class="text-muted fw-semibold" id="companyName"></span></p>
                    </div>
                    <div class="col-md-4 d-flex justify-content-end">
                        <div id="bankAction" class="w-100">
                               </div>
                    </div>
                </div>
                
                <h5 class="fw-bold text-secondary mb-3"><i class="fas fa-list-ul me-2"></i>Referred Client Details</h5>
                <div class="table-responsive">
                    <table class="table table-bordered table-striped align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Description</th>
                                <th>Client Name</th>
                                <th>Location</th>
                                <th>Phone Number</th>
                                <th>Email</th>
                                <th>Visa Country</th>
                                <th>Status</th>
                                <th>Amount Paid</th>
                                <!-- <th>Bifurcation</th> -->
                            </tr>
                        </thead>
                        <tbody id="referralTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="bankModal" tabindex="-1" aria-labelledby="bankModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content rounded-4">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="bankModalLabel"><i class="fas fa-university me-2"></i> Add/Edit Bank Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bankForm">
                        <div class="mb-3">
                            <label class="form-label">Client ID</label>
                            <input type="text" class="form-control" id="bankClientId" name="clientId" readonly />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Account Holder Name</label>
                            <input type="text" class="form-control" id="holderName" name="holderName" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Bank Name</label>
                            <input type="text" class="form-control" id="bankName" name="bankName" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Account Number</label>
                            <input type="text" class="form-control" id="accountNumber" name="accountNumber" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">IFSC Code</label>
                            <input type="text" class="form-control" id="ifscCode" name="ifscCode" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">UPI ID (optional)</label>
                            <input type="text" class="form-control" id="upiId" name="upiId" placeholder="e.g. name@bank" />
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-success px-4" id="submitBankBtn">Submit Details</button>
                            <div id="bankLoading" class="mt-3 text-primary fw-semibold" style="display:none;">
                                <i class="fa fa-spinner fa-spin"></i> Submitting your details...
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <footer class="footer">
        ¬© 2025 ASTours International ‚Äî Building Global Travel Connections üåç
    </footer>
    
    <script>
        // --- GOOGLE SHEET/APPS SCRIPT URLs (Keep these updated) ---
        const sheet1URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRo6-BtopCTAxjdLY2iY08PhtfTpYrOI0AovFYRye9F2Qi7rM9Dp5pDpSwzBSEYi93Uh3LwLHgG9in3/pub?gid=0&single=true&output=csv";
        const sheet2URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRo6-BtopCTAxjdLY2iY08PhtfTpYrOI0AovFYRye9F2Qi7rM9Dp5pDpSwzBSEYi93Uh3LwLHgG9in3/pub?gid=1560195772&single=true&output=csv";
        const bankSheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRo6-BtopCTAxjdLY2iY08PhtfTpYrOI0AovFYRye9F2Qi7rM9Dp5pDpSwzBSEYi93Uh3LwLHgG9in3/pub?gid=940535614&single=true&output=csv";
        const scriptURL = "https://script.google.com/macros/s/AKfycbzvK476S4FL5QL6siPAeRbSfqhxbtj-6NgmAdq5128ahWTgUEoUzsjpl39W5tcPWTJcEA/exec";

        // ‚úÖ ENHANCED CSV Parser to handle newlines within cells
        const parseCSV = (csv) => {
            // 1. Remove ALL internal newline characters (CR/LF) from the data stream.
            const cleanedCSV = csv.replace(/(\r\n|\n|\r)(?=[^,]*"(?:[^"]*"[^,]*")*[^"]*$)/g, ' '); 
            
            // Re-apply split logic
            const rows = cleanedCSV.split(/\r?\n/).filter(r => r.trim() !== "");
            if (rows.length === 0) return [];
            
            // Handle headers with spaces and normalize
            const headers = rows.shift().split(",").map(h => h.trim().toLowerCase().replace(/"/g, ''));
            
            return rows.map(r => {
                // Split row by comma, ignoring commas inside double quotes
                const values = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); 
                const obj = {};
                headers.forEach((h, i) => {
                    // Trim, handle null/undefined, and remove surrounding quotes
                    let value = (values[i] || "").trim().replace(/^"|"$/g, '');
                    // Add trimming for whitespace before/after the Client ID (key fix for space issue)
                    if (h === "client id" || h === "clientid") {
                         value = value.trim();
                    }
                    obj[h] = value;
                });
                return obj;
            });
        };

        // ‚úÖ FETCH CLIENT REFERRAL DATA (FIXED LOGIC for BankClientId)
        async function fetchReferral() {
            // Apply trimming to ensure no spaces break the client ID matching
            const clientId = document.getElementById("clientId").value.trim(); 
            if (!clientId) {
                alert("‚ö†Ô∏è Please enter a valid Partner ID");
                return;
            }

            document.getElementById("loading").style.display = "block";
            document.getElementById("resultSection").style.display = "none";
            document.getElementById("bankAction").innerHTML = "";

            try {
                const [sheet1, sheet2, bankSheet] = await Promise.all([
                    fetch(sheet1URL).then(r => r.text()),
                    fetch(sheet2URL).then(r => r.text()),
                    fetch(bankSheetURL).then(r => r.text())
                ]);

                const data1 = parseCSV(sheet1);
                const data2 = parseCSV(sheet2);
                const bankData = parseCSV(bankSheet);

                // Find partner info using trimmed client ID
                const partner = data1.find(p => p["client id"] === clientId || p["clientid"] === clientId);
                
                if (!partner) {
                    alert("‚ùå Partner ID not found. Please check again.");
                    document.getElementById("loading").style.display = "none";
                    return;
                }

                // Display Partner Info
                document.getElementById("loading").style.display = "none";
                document.getElementById("resultSection").style.display = "block";
                document.getElementById("clientIdDisplay").innerText = partner["client id"] || partner["clientid"];
                document.getElementById("companyName").innerText = partner["company name"] || "N/A";

                // Display Referral Table
                const referrals = data2.filter(r => r["client id"] === clientId || r["clientid"] === clientId);
                const table = document.getElementById("referralTable");
                table.innerHTML = "";

                if (referrals.length === 0) {
                    table.innerHTML = `<tr><td colspan="9" class="text-center text-muted">No clients referred by you yet.</td></tr>`;
                } else {
                    referrals.forEach(r => {
                        const desc = r["description"] && r["description"].trim() !== "" ? r["description"] : "N/A";
                        const amount = r["amount paid"] || "N/A";
                        // const bifurcation = r["bifurcation"] || "N/A";
                        
                        table.innerHTML += `
                            <tr>
                                <td>${desc}</td>
                                <td>${r["client name"] || "N/A"}</td>
                                <td>${r["location"] || "N/A"}</td>
                                <td>${r["phone number"] || "N/A"}</td>
                                <td>${r["email"] || "N/A"}</td>
                                <td>${r["visa country"] || "N/A"}</td>
                                <td>${r["status"] || "N/A"}</td>
                                <td>${amount}</td>
                            </tr>`;
                    });
                }

                // ** CRITICAL FIX **: Set the Client ID for the Bank form FIRST, before any potential reset.
                document.getElementById("bankClientId").value = clientId;

                // Reset the *other* form fields to ensure a clean slate before populating
                document.getElementById("holderName").value = "";
                document.getElementById("bankName").value = "";
                document.getElementById("accountNumber").value = "";
                document.getElementById("ifscCode").value = "";
                document.getElementById("upiId").value = "";
                
                // Prefill Bank Details if Exist
                const existingBank = bankData.find(
                    b => b["client id"] === clientId || b["clientid"] === clientId
                );

                if (existingBank) {
                    // Populate fields for EDIT mode
                    document.getElementById("holderName").value = existingBank["holder name"] || "";
                    document.getElementById("bankName").value = existingBank["bank name"] || "";
                    document.getElementById("accountNumber").value = existingBank["account number"] || "";
                    document.getElementById("ifscCode").value = existingBank["ifsc code"] || "";
                    document.getElementById("upiId").value = existingBank["upi id"] || "";

                    document.getElementById("bankAction").innerHTML = `
                        <button class="btn btn-primary w-100" onclick="openBankEditModal()">üí≥ View / Edit Bank Details</button>`;
                } else {
                    // Set action for ADD mode
                    document.getElementById("bankAction").innerHTML = `
                        <button class="btn btn-success w-100" onclick="openBankEditModal()">üè¶ Add Bank Details</button>`;
                }

            } catch (err) {
                console.error("Fetch Error:", err);
                alert("‚ö†Ô∏è Error loading referral data. Please check the sheet URLs and network connection.");
            } finally {
                document.getElementById("loading").style.display = "none";
            }
        }

        // BANK FORM SUBMISSION HANDLER
        document.getElementById("bankForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const formData = new FormData(document.getElementById("bankForm"));
            // Ensure clientId is included in the submission data
            formData.append('clientId', document.getElementById("bankClientId").value.trim()); 
            
            const data = Object.fromEntries(formData.entries());

            document.getElementById("submitBankBtn").disabled = true;
            document.getElementById("bankLoading").style.display = "block";

            try {
                const response = await fetch(scriptURL, {
                    method: "POST",
                    body: new URLSearchParams(data),
                });

                const result = await response.text().then(r => r.trim());

                if (result.includes("Updated") || result.includes("Added") || result.includes("success")) {
                    alert("‚úÖ Bank details saved successfully!");
                } else {
                    alert("‚ö†Ô∏è Submission response: " + result);
                }

                // Only reset the non-ID fields is necessary after submission
                // document.getElementById("bankForm").reset(); // REMOVED: Since it clears the Client ID field

                const modalElement = document.getElementById('bankModal');
                const modalInstance = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                modalInstance.hide();
                
                fetchReferral(); // Refresh data to show View/Edit button

            } catch (err) {
                console.error(err);
                alert("‚ùå Submission failed. Please try again later.");
            } finally {
                document.getElementById("submitBankBtn").disabled = false;
                document.getElementById("bankLoading").style.display = "none";
            }
        });


        // OPEN BANK MODAL MANUALLY
        function openBankEditModal() {
            const bankModal = new bootstrap.Modal(document.getElementById('bankModal'));
            bankModal.show();
        }

        // TAILWIND NAVBAR SCRIPT
        document.getElementById('mobileBtn').addEventListener('click', () => {
            document.getElementById('mobileMenu').classList.toggle('hidden');
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>