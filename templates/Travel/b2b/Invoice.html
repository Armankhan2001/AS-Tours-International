<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B2B Invoice Generator</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700;900&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

    <style>
        /* Navbar Custom Variables */
        :root {
            --navy: #07203a;
            --gold: #d4af37;
        }

        /* Base Invoice Styles */
        body { 
            font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f1f5f9; 
            margin: 0;
            padding-top: 160px; 
        }

        /* Navbar & Typography Styles */
        .font-playfair { font-family: 'Playfair Display', serif; }
        .nav-link {
            font-size: 0.875rem; 
            font-weight: 500;
            transition: color 0.3s;
        }

        /* Premium CTA button */
        .btn-gold {
            background: linear-gradient(90deg, var(--gold), #f3d27a);
            color: var(--navy);
            font-weight: 600;
            font-size: 0.875rem; 
            transition: all 0.3s ease;
        }
        .btn-gold:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }

        /* Logo badge style (for navbar) - Desktop Default */
        .logo-badge {
            height: 160px;
            width: 160px;
            background-color: #ffd700;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 60; 
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            overflow: hidden;
        }
        .logo-badge img {
            width: 90%;
            height: auto;
            padding: 4px;
        }
        
        /* Mobile Logo Adjustment & Body Padding */
        @media (max-width: 1023px) {
            .logo-badge {
                height: 100px; 
                width: 100px;
            }
            body {
                padding-top: 100px; 
            }
        }

        /* Invoice Generator Styles */
        .invoice-box { 
            background: #fff; 
            padding: 30px; 
            border-radius: 16px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            max-width: 900px; 
            margin: 20px auto; 
        }
        table { border-collapse: collapse; width: 100%; margin-top: 15px; }
        th, td { border: 1px solid #d1d5db; padding: 10px; text-align: left; }
        th { background: #b0b8c6; }
        
        /* Adjusted button styles */
        .btn { padding: 10px 15px; border-radius: 8px; margin: 5px; font-weight: bold; cursor: pointer; transition: background 0.2s, transform 0.2s; }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary { background: #2563eb; color: #fff; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-secondary { background: #16a34a; color: #fff; }
        .btn-secondary:hover { background: #15803d; }
        .btn-warning { background: #eab308; color: #fff; }
        .btn-warning:hover { background: #ca8a04; }
        .btn-share { background: #f97316; color: #fff; }
        .btn-share:hover { background: #c2410c; }

        .status-paid { color: green; font-weight: bold; }
        .status-partial { color: orange; font-weight: bold; }
        .status-none { color: red; font-weight: bold; }
        
        /* Logo Sizing */
        #pCompanyLogo {
            max-width: 240px; 
            max-height: 120px; 
            min-width: 0; 
            object-fit: contain; 
            margin-bottom: 10px;
        }

        /* Constrain the left column width */
        #invoiceContent .invoice-header > div:first-child {
            max-width: 60%; 
            flex-shrink: 0; 
        }


        /* Desktop Layout Enforcement */
        #invoiceContent .invoice-header {
            display: flex;
            flex-direction: row !important; 
            justify-content: space-between;
            align-items: flex-start;
        }
        #invoiceContent .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr !important; 
            gap: 1.5rem; 
        }
        #invoiceContent .detail-right {
             padding-left: 2.5rem !important; 
             text-align: right !important;
        }
        
        /* Mobile View Reduction */
        @media (max-width: 639px) {
            .invoice-box {
                padding: 15px;
            }
            #invoiceContent {
                padding: 15px !important; 
            }
            #invoiceContent h1 { font-size: 1.3rem !important; }
            #invoiceContent h2 { font-size: 0.9rem !important; }
            #invoiceContent p, #invoiceContent span, #invoiceContent td { font-size: 0.63rem !important; }
            #invoiceContent th { font-size: 0.875rem !important; padding: 8px !important; }
            #pCompanyName { font-size: 1.25rem !important; }
            #pCompanyLogo { 
                max-width: 150px;
                max-height: 75px;
                min-width: 0;
                object-fit: contain;
                margin-bottom: 10px;
            }
        }


        /* ---------------------------------------------------------------------------------- */
        /* ‚úÖ FINAL PRINT/PDF STYLES: FIXED HEIGHT/WIDTH, NO STRETCH, PREMIUM LOOK */
        /* ---------------------------------------------------------------------------------- */
        @media print {
            body * { visibility: hidden; }
            #invoiceContent, #invoiceContent * { visibility: visible; }
            
            /* The overall content container */
            #invoiceContent { 
                position: absolute; 
                left: 0; 
                top: 0; 
                padding: 10px !important; 
                margin: 0 !important; 
                width: 100%;
                box-shadow: none;
                
                /* ‚úÖ PREMIUM BORDER LOOK */
                border: 4px solid var(--navy) !important; 
                border-radius: 12px !important;
                background-color: #fff !important; 
                
                /* CRITICAL: Force the rendering engine to respect colors and styles */
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important;
            }
            
            /* Fix 1: Ensure the container for the logo/company name is stable */
            #invoiceContent .invoice-header > div:first-child {
                max-width: 45% !important; /* Reduced width for more stability */
                flex-basis: 45% !important;
                flex-shrink: 0 !important;
            }

            /* Fix 2: Prevent image stretching and enforce aspect ratio */
            #pCompanyLogo {
                max-width: 180px !important; /* Fixed maximum width */
                max-height: 80px !important; /* Fixed maximum height */
                width: auto !important; /* Allow width to be determined by content/ratio */
                height: auto !important; /* Allow height to be determined by content/ratio */
                object-fit: contain !important; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important;
                margin-bottom: 5px !important;
            }

            /* Height/Spacing Optimization */
            .mb-8 { margin-bottom: 0.75rem !important; } 
            .mb-2 { margin-bottom: 0.25rem !important; } 
            .mt-2 { margin-top: 0.25rem !important; } 
            .pb-4 { padding-bottom: 0.5rem !important; } 
            .pt-4 { padding-top: 0.5rem !important; } 
            
            /* Font Size Optimization for Single Page Fit */
            #invoiceContent h1 { font-size: 2.5rem !important; color: var(--navy) !important; } 
            #invoiceContent h2 { font-size: 1rem !important; color: var(--navy) !important; } 
            #pCompanyName { font-size: 1.5rem !important; color: var(--navy) !important; }
            
            #invoiceContent p, 
            #invoiceContent span, 
            #invoiceContent td {
                font-size: 0.8rem !important; 
                line-height: 1.2 !important; 
                padding: 4px 8px !important; 
            }
            /* ‚úÖ PREMIUM TABLE HEADER STYLE */
            #invoiceTable th { 
                font-size: 0.9rem !important; 
                padding: 8px 10px !important;
                background-color: var(--navy) !important; 
                color: #fff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            /* ‚úÖ PREMIUM PAYMENT BOX STYLE */
            #pBankDetails {
                border: 1px dashed var(--navy) !important;
                background-color: #f7f9fd !important; 
                padding: 8px !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Layout Enforcement */
            .invoice-details {
                grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
            }
        }
        /* ---------------------------------------------------------------------------------- */
        
        /* Modern Toast Notification Style */
        #toastNotification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10b981; 
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            font-weight: 600;
        }
        #toastNotification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body class="antialiased p-0 sm:p-6">

    <header class="fixed top-0 w-full z-50 bg-white/95 backdrop-blur-md shadow-sm">
        <div class="max-w-7xl mx-auto px-4 lg:px-8">
            <div class="flex items-center justify-between h-16">

                <div class="absolute top-0 left-4 z-50">
                    <a href="#home" class="logo-badge">
                        <img src="../../../image/astourlogo.png" alt="AS Tours International Logo"> 
                    </a>
                </div>

                <div class="w-24 lg:w-40 flex-shrink-0"></div>

                <nav class="hidden lg:flex items-center gap-6 text-[var(--navy)]">
                    <a href="#invoiceForm" class="nav-link hover:text-[var(--gold)]">New Invoice</a>
                    <a href="#savedInvoicesSection" class="nav-link hover:text-[var(--gold)]">Saved Invoices</a>
                    <a href="#invoicePreview" class="nav-link hover:text-[var(--gold)]">Preview</a>
                    <a href="#contact" class="nav-link hover:text-[var(--gold)]">Contact</a>
                    <a href="#" class="ml-4 px-5 py-2 rounded-full btn-gold">Generate & Save</a>
                </nav>

                <div class="lg:hidden ml-auto">
                    <button id="mobileBtn" class="p-2 rounded-md hover:bg-gray-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-[var(--navy)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                </div>

            </div>
        </div>

        <div id="mobileMenu" class="hidden lg:hidden bg-white border-t border-gray-200 w-full">
            <div class="px-6 py-4 space-y-3 text-[var(--navy)] font-medium">
                <a href="#invoiceForm" class="nav-link block hover:text-[var(--gold)]">New Invoice</a>
                <a href="#savedInvoicesSection" class="nav-link block hover:text-[var(--gold)]">Saved Invoices</a>
                <a href="#invoicePreview" class="nav-link block hover:text-[var(--gold)]">Preview</a>
                <a href="#contact" class="nav-link block hover:text-[var(--gold)]">Contact</a>
                <a href="#" class="block mt-2 px-4 py-2 rounded-full btn-gold text-center">Generate & Save</a>
            </div>
        </div>
    </header>
    
    <div id="toastNotification"></div>

    <h2 class="text-center text-3xl font-bold mb-6 text-blue-700 mt-4">B2B Invoice Generator</h2>
    
    <hr>

    <div class="invoice-box" id="invoiceForm">
        <h3 class="font-bold text-lg mb-4 border-b pb-2">Fill Invoice Details</h3>
        <form id="invoiceForm" class="grid grid-cols-1 md:grid-cols-2 gap-4"> 

            <input class="border p-2 col-span-1 md:col-span-2 rounded-md" type="text" id="companyName" placeholder="Your Company Name" value="Solo2CEO Pvt Ltd" required>
            <input class="border p-2 col-span-1 md:col-span-2 rounded-md" type="text" id="companyAddress" placeholder="Company Address (optional)" value="Bandra West, Mumbai, India">
            <input class="border p-2 col-span-1 rounded-md" type="text" id="companyContact" placeholder="Company Contact Number" value="+91 99999 12345">
            <input class="border p-2 col-span-1 rounded-md" type="email" id="companyEmail" placeholder="Company Email" value="info@solo2ceo.com">

            <input class="border p-2 col-span-1 rounded-md" type="text" id="bankName" placeholder="Bank Name" value="HDFC Bank">
            <input class="border p-2 col-span-1 rounded-md" type="text" id="accountHolder" placeholder="Account Holder Name" value="Solo2CEO Pvt Ltd">
            <input class="border p-2 col-span-1 rounded-md" type="text" id="accountNumber" placeholder="Account Number" value="12345678901234">
            <input class="border p-2 col-span-1 rounded-md" type="text" id="ifscCode" placeholder="IFSC Code" value="HDFC0001234">
            <input class="border p-2 col-span-1 md:col-span-2 rounded-md" type="text" id="upiID" placeholder="UPI ID (optional)" value="solo2ceo@hdfcbank">

            <label class="col-span-1 md:col-span-2 text-sm text-gray-600 pt-2 border-t mt-2">Upload Company Logo OR Provide Logo URL</label>
            <input class="border p-2 col-span-1 rounded-md text-sm" type="file" id="companyLogoFile" accept="image/*">
            <input class="border p-2 col-span-1 rounded-md" type="text" id="companyLogoURL" placeholder="Or paste Logo Image URL">
            
            <label class="col-span-1 md:col-span-2 text-sm text-gray-600 pt-2 border-t mt-2">Invoice & Client Information</label>
            <input class="border p-2 col-span-1 rounded-md" type="text" id="invoiceNo" placeholder="Invoice Number" value="INV-1001" required>
            <input class="border p-2 col-span-1 rounded-md" type="date" id="invoiceDate" required>
            <input class="border p-2 col-span-1 rounded-md" type="text" id="clientName" placeholder="Client Name" value="AsTours International" required>
            <input class="border p-2 col-span-1 rounded-md" type="text" id="clientPhone" placeholder="Client Phone" value="+91 9876543210">
            <input class="border p-2 col-span-1 md:col-span-2 rounded-md" type="text" id="clientAddress" placeholder="Client Address" value="Mumbai, India" required>
            
            <textarea class="border p-2 col-span-1 md:col-span-2 rounded-md" id="description" placeholder="Service Description">Website Design & SEO Package</textarea>
            <input class="border p-2 col-span-1 rounded-md" type="number" id="price" placeholder="Price (Rs)" value="25000" required>
            <input class="border p-2 col-span-1 rounded-md" type="number" id="discount" placeholder="Discount (Rs)" value="1000">
            <input class="border p-2 col-span-1 rounded-md" type="number" id="advance" placeholder="Advance Paid (Rs)" value="5000">
            <input class="border p-2 col-span-1 rounded-md" type="number" id="finalPayment" placeholder="Final Payment (Rs)" value="19000">
        </form>

        <div class="mt-6 text-center flex flex-wrap justify-center gap-3">
            <button onclick="generateInvoice()" class="btn btn-primary w-full sm:w-auto">Generate Preview</button>
            <button onclick="saveInvoice()" class="btn btn-secondary w-full sm:w-auto">üíæ Save Invoice</button>
        </div>
        <p id="saveMsg" class="text-center text-green-700 font-semibold mt-2"></p>
    </div>

    <hr>

    <div class="invoice-box" id="savedInvoicesSection">
        <h3 class="font-bold text-lg mb-2 border-b pb-2">üìú Saved Invoices</h3>

        <div class="flex flex-col sm:flex-row gap-2 mb-3">
            <input id="searchInput" type="text" class="border p-2 flex-grow rounded-md" placeholder="Search by Invoice No or Client Name">
            <button onclick="searchInvoices()" class="btn btn-primary flex-shrink-0">Search</button>
        </div>

        <div id="recentInvoices" class="text-sm text-gray-700">
            <p>Loading invoices...</p>
        </div>
    </div>

    <hr>

    <div id="invoicePreview" class="invoice-box hidden">
        <div id="invoiceContent" class="p-6">
            
            <div class="invoice-header mb-8 border-b pb-4">
                <div class="flex flex-col">
                    <img id="pCompanyLogo" alt="Company Logo" class="hidden">
                    <h1 id="pCompanyName" class="font-playfair text-3xl font-bold text-blue-800 mt-2"></h1>
                    <p id="pCompanyAddress" class="text-sm text-gray-600 mt-1"></p>
                    <p id="pCompanyContact" class="text-xs text-gray-600"></p>
                    <p id="pCompanyEmail" class="text-xs text-gray-600"></p>
                </div>
                <h1 class="text-5xl font-playfair font-extrabold text-blue-500/80 tracking-tight">INVOICE</h1>
            </div>

            <div class="invoice-details gap-y-4 mb-8 text-sm">
                <div class="col-span-1">
                    <h2 class="text-lg font-bold text-gray-700 mb-2 border-b pb-1">BILLED TO</h2>
                    <p id="pClientName" class="font-semibold text-gray-800"></p>
                    <p id="pClientAddress" class="text-gray-600"></p>
                    <p id="pClientPhone" class="text-gray-600"></p>
                </div>
                <div class="col-span-1 detail-right">
                    <h2 class="text-lg font-bold text-gray-700 mb-2 border-b pb-1">INVOICE DETAILS</h2>
                    <p class="mb-1"><b>Invoice No:</b> <span id="pInvoiceNo" class="font-semibold text-blue-700"></span></p>
                    <p class="mb-1"><b>Date:</b> <span id="pInvoiceDate" class="font-semibold"></span></p>
                    <p class="mt-4"><b>Status:</b> <span id="pStatus" class="font-bold"></span></p>
                </div>
            </div>

            <table id="invoiceTable" class="shadow-md rounded-lg overflow-hidden mb-8">
                <thead>
                    <tr class="bg-gray-900 text-white"> 
                        <th class="w-2/3">Particulars</th>
                        <th class="w-1/3 text-right">Amount (Rs)</th>
                    </tr>
                </thead>
                <tbody id="invoiceBody"></tbody>
            </table>

            <div class="mt-8 pt-4 border-t-4 border-blue-100">
                <h3 class="font-semibold text-xl text-blue-700 mb-2">Payment Information</h3>
                <p id="pBankDetails" class="text-sm text-gray-700 bg-blue-50 p-3 rounded-lg" 
                    style="background-color: #eff6ff;">
                </p>
            </div>

            <p class="mt-6 text-center text-lg text-blue-700 font-semibold italic">Thank you for your business!</p>
        </div>

        <div class="mt-6 text-center flex flex-wrap justify-center gap-2 sm:gap-4">
            <button onclick="downloadPDF()" class="btn btn-primary">‚¨áÔ∏è Download PDF</button> 
            <button onclick="shareWhatsApp()" class="btn btn-secondary">Share WhatsApp</button>
            <button onclick="shareEmail()" class="btn btn-warning">Share Email</button>
            <button onclick="shareNative()" class="btn btn-share">Share More Apps</button>
        </div>
    </div>

    <script>
        // Navbar Mobile Toggle Script
        document.getElementById('mobileBtn').addEventListener('click', () => {
            document.getElementById('mobileMenu').classList.toggle('hidden');
        });

        document.querySelectorAll('#mobileMenu a').forEach(link => {
            link.addEventListener('click', () => {
                document.getElementById('mobileMenu').classList.add('hidden');
            });
        });

        // üü¢ Toast Notification Function
        function showToast(message, isError = false) {
            const toast = document.getElementById('toastNotification');
            toast.textContent = message;
            toast.style.backgroundColor = isError ? '#ef4444' : '#10b981'; // red for error, green for success
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000); 
        }

        // NOTE: Ensure this URL points to your deployed Google Apps Script
        const scriptURL = "https://script.google.com/macros/s/AKfycbzw2mZGGCrVv5N7YdIy7Wpc327bso9oSuYHXSddUQKOSvMIZ2tbbje0vuniyy5DaO7B/exec"; 

        function formatCurrency(amount) {
            return `Rs ${amount.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
        }
        
        // Helper function to format date string to YYYY-MM-DD for input fields
        function formatDateToInput(dateString) {
            if (!dateString) return '';
            try {
                // Assuming dateString is in DD/MM/YYYY format from the script
                const [day, month, year] = dateString.split('/');
                if (day && month && year) {
                     return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }
                // Fallback for native date objects or standard formats
                const date = new Date(dateString);
                if (isNaN(date)) return dateString;
                return date.toISOString().split('T')[0];
            } catch {
                return dateString;
            }
        }


        function generateInvoice() {
            const companyName = document.getElementById('companyName').value;
            const companyAddress = document.getElementById('companyAddress').value;
            const companyContact = document.getElementById('companyContact').value;
            const companyEmail = document.getElementById('companyEmail').value;
            const bankName = document.getElementById('bankName').value;
            const accountHolder = document.getElementById('accountHolder').value;
            const accountNumber = document.getElementById('accountNumber').value;
            const ifscCode = document.getElementById('ifscCode').value;
            const upiID = document.getElementById('upiID').value;

            const companyLogoFile = document.getElementById('companyLogoFile').files[0];
            const companyLogoURL = document.getElementById('companyLogoURL').value;

            const invoiceNo = document.getElementById('invoiceNo').value;
            // Display date should be nicely formatted, even if input value is YYYY-MM-DD
            const invoiceDateInput = document.getElementById('invoiceDate').value;
            const invoiceDateDisplay = invoiceDateInput ? new Date(invoiceDateInput).toLocaleDateString('en-IN') : new Date().toLocaleDateString('en-IN');
            
            const clientName = document.getElementById('clientName').value;
            const clientAddress = document.getElementById('clientAddress').value;
            const clientPhone = document.getElementById('clientPhone').value;
            const description = document.getElementById('description').value;
            const price = parseFloat(document.getElementById('price').value) || 0;
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const advance = parseFloat(document.getElementById('advance').value) || 0;
            const finalPayment = parseFloat(document.getElementById('finalPayment').value) || 0;

            const total = price - discount;
            const totalPaid = advance + finalPayment;
            const pending = total - totalPaid;

            // Company section
            document.getElementById('pCompanyName').innerText = companyName;
            document.getElementById('pCompanyAddress').innerText = companyAddress;
            document.getElementById('pCompanyContact').innerText = companyContact ? `üìû ${companyContact}` : '';
            document.getElementById('pCompanyEmail').innerText = companyEmail ? `‚úâÔ∏è ${companyEmail}` : '';
            
            const bankDetailsText = `üè¶ Bank: ${bankName} | A/C Holder: ${accountHolder} | A/C No: ${accountNumber} | IFSC: ${ifscCode} | UPI ID: ${upiID || 'N/A'}`;
            document.getElementById('pBankDetails').innerText = bankDetailsText;


            const logoElement = document.getElementById('pCompanyLogo');
            logoElement.src = ''; 
            if (companyLogoFile) {
                const reader = new FileReader();
                reader.onload = e => { 
                    logoElement.src = e.target.result; 
                    logoElement.classList.remove("hidden"); 
                };
                reader.readAsDataURL(companyLogoFile);
            } else if (companyLogoURL.trim() !== "") {
                logoElement.src = companyLogoURL;
                logoElement.classList.remove("hidden");
            } else {
                logoElement.classList.add("hidden");
            }


            document.getElementById('pInvoiceNo').innerText = invoiceNo;
            document.getElementById('pInvoiceDate').innerText = invoiceDateDisplay;
            document.getElementById('pClientName').innerText = clientName;
            document.getElementById('pClientAddress').innerText = clientAddress;
            document.getElementById('pClientPhone').innerText = clientPhone;
            
            // Build Table Rows
            let rows = `
                <tr>
                    <td>${description}</td>
                    <td class="text-right">${formatCurrency(price)}</td>
                </tr>
            `;

            if (discount > 0) rows += `
                <tr class="bg-red-50/50 text-red-700">
                    <td>Discount</td>
                    <td class="text-right">- ${formatCurrency(discount)}</td>
                </tr>
            `;

            rows += `
                <tr class="font-bold text-gray-800 bg-gray-200">
                    <td>Total Payable</td>
                    <td class="text-right">${formatCurrency(total)}</td>
                </tr>
            `;

            let status = "";
            let statusHtml = "";
            if (totalPaid >= total) {
                status = "Paid";
                statusHtml = "<span class='status-paid'>‚úÖ Paid in Full</span>";
            } else if (advance > 0) {
                status = "Partial";
                statusHtml = "<span class='status-partial'>‚ö†Ô∏è Partial Payment</span>";
            } else {
                status = "Unpaid";
                statusHtml = "<span class='status-none'>‚ùå Unpaid</span>";
            }

            if (advance > 0) {
                rows += `
                    <tr>
                        <td>Advance Paid</td>
                        <td class="text-right">${formatCurrency(advance)}</td>
                    </tr>
                `;
            }
            if (pending > 0) {
                rows += `
                    <tr class="font-bold bg-yellow-50 text-orange-700">
                        <td>Pending Amount</td>
                        <td class="text-right">${formatCurrency(pending)}</td>
                    </tr>
                `;
            }
            
            document.getElementById('invoiceBody').innerHTML = rows;
            document.getElementById('pStatus').innerHTML = statusHtml;

            document.getElementById('invoicePreview').classList.remove('hidden');
            document.getElementById('invoicePreview').scrollIntoView({ behavior: 'smooth' });
            showToast("Invoice preview generated successfully!");
          }

          async function saveInvoice() {
          const cleanCompanyPhone = document.getElementById('companyContact').value.replace(/^\+91\s*/, "");
          const cleanClientPhone = document.getElementById('clientPhone').value.replace(/^\+91\s*/, "");

          const price = parseFloat(document.getElementById('price').value) || 0;
          const discount = parseFloat(document.getElementById('discount').value) || 0;
          const advance = parseFloat(document.getElementById('advance').value) || 0;
          const finalPayment = parseFloat(document.getElementById('finalPayment').value) || 0;

          const total = price - discount;
          const pending = total - (advance + finalPayment);

          let status = "";
          if ((advance + finalPayment) >= total) status = "Paid";
          else if (advance > 0) status = "Partial";
          else status = "Unpaid";

          const data = {
            companyName: document.getElementById('companyName').value,
            companyAddress: document.getElementById('companyAddress').value,
            companyContact: cleanCompanyPhone,
            companyEmail: document.getElementById('companyEmail').value,
            bankName: document.getElementById('bankName').value,
            accountHolder: document.getElementById('accountHolder').value,
            accountNumber: document.getElementById('accountNumber').value,
            ifscCode: document.getElementById('ifscCode').value,
            upiID: document.getElementById('upiID').value,
            invoiceNo: document.getElementById('invoiceNo').value,
            invoiceDate: document.getElementById('invoiceDate').value,
            clientName: document.getElementById('clientName').value,
            clientPhone: cleanClientPhone,
            clientAddress: document.getElementById('clientAddress').value,
            description: document.getElementById('description').value,
            price: price,
            discount: discount,
            advance: advance,
            finalPayment: finalPayment,
            total: total,
            pending: pending,
            status: status,
            logoURL: document.getElementById('companyLogoURL').value || ""
          };

          document.getElementById("saveMsg").textContent = "‚è≥ Saving...";
          try {
            await fetch(scriptURL, {
              method: "POST",
              mode: "no-cors",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data)
            });

            document.getElementById("saveMsg").textContent = "‚úÖ Saved Successfully!";
            showToast("Invoice saved to database!");
          } catch (err) {
            document.getElementById("saveMsg").textContent = "‚ùå Failed to Save!";
            showToast("Failed to save invoice!", true);
            console.error(err);
          }
        }


        // Saved Invoices Preview
        const ADMIN_PASSWORD = "Admin@b2b";
        let isAuthenticated = false;

        // üîê Ask for password before showing invoices
        window.addEventListener("DOMContentLoaded", () => {
          const container = document.getElementById("recentInvoices");
          container.innerHTML = `
            <div class="p-3 border rounded-lg bg-gray-50">
              <p class="mb-2 font-semibold text-gray-700">üîí Enter password to view invoices</p>
              <input type="password" id="adminPass" placeholder="Enter Password" class="border p-2 w-full rounded-md mb-2">
              <button onclick="verifyPassword()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Unlock</button>
            </div>
          `;
          
          // Enable Enter key for password submission
          document.getElementById('adminPass').addEventListener('keypress', function(e) {
              if (e.key === 'Enter') {
                  e.preventDefault(); 
                  verifyPassword();
              }
          });
        });

        // ‚úÖ Verify password
        function verifyPassword() {
          const inputPass = document.getElementById("adminPass").value.trim();
          const container = document.getElementById("recentInvoices");

          if (inputPass === ADMIN_PASSWORD) {
            isAuthenticated = true;
            container.innerHTML = "<p>Loading invoices...</p>";
            loadInvoices(); 
          } else {
            showToast("‚ùå Incorrect password! Please try again.", true);
            document.getElementById("adminPass").value = "";
          }
        }

        // ‚úÖ Fetch & show last 3 invoices
        async function loadInvoices() {
          if (!isAuthenticated) return; 

          const container = document.getElementById("recentInvoices");
          container.innerHTML = "<p>‚è≥ Loading invoices...</p>"; 

          try {
            const res = await fetch(scriptURL);
            const invoices = await res.json();

            if (!Array.isArray(invoices) || invoices.length === 0) {
              container.innerHTML = "<p>No saved invoices yet.</p>";
              return;
            }

            const last3 = invoices.slice(-3).reverse();
            container.innerHTML = last3.map(inv => `
              <div class="border rounded-lg p-2 mb-2 hover:bg-blue-50 transition-colors cursor-pointer" 
                    onclick='loadInvoiceToForm(${JSON.stringify(inv)})'>
                <p><b>${inv["Invoice No"]}</b> - ${inv["Client Name"]}</p>
                <p class="text-xs text-gray-500">${inv["Invoice Date"]}</p>
              </div>
            `).join('');
          } catch (err) {
            container.innerHTML = "<p class='text-red-500'>Failed to load invoices!</p>";
            console.error(err);
          }
        }

        // üîç Search invoices (only if logged in)
        async function searchInvoices() {
          if (!isAuthenticated) {
            showToast("üîê Please enter the admin password first.", true); 
            return;
          }

          const query = document.getElementById("searchInput").value.trim().toLowerCase();
          const container = document.getElementById("recentInvoices");

          if (!query) return loadInvoices(); 
          
          container.innerHTML = "<p>üîé Searching for invoices...</p>"; 

          try {
            const res = await fetch(scriptURL);
            const invoices = await res.json();

            const results = invoices.filter(inv =>
              (inv["Invoice No"] && inv["Invoice No"].toLowerCase().includes(query)) ||
              (inv["Client Name"] && inv["Client Name"].toLowerCase().toLowerCase().includes(query))
            );

            if (results.length === 0) {
              container.innerHTML = "<p>No matching invoices found.</p>";
              return;
            }

            container.innerHTML = results.reverse().map(inv => `
              <div class="border rounded-lg p-2 mb-2 hover:bg-blue-50 transition-colors cursor-pointer" 
                    onclick='loadInvoiceToForm(${JSON.stringify(inv)})'>
                <p><b>${inv["Invoice No"]}</b> - ${inv["Client Name"]}</p>
                <p class="text-xs text-gray-500">${inv["Invoice Date"]}</p>
              </div>
            `).join('');
          } catch (err) {
            container.innerHTML = "<p class='text-red-500'>Search failed!</p>";
            console.error(err);
          }
        }

        // ‚ôªÔ∏è Load selected invoice data back into the form
        function loadInvoiceToForm(inv) {
          // Note: The data object uses keys with spaces from the Google Sheet
          document.getElementById('companyName').value = inv["Company Name"] || '';
          document.getElementById('companyAddress').value = inv["Company Address"] || '';
          document.getElementById('companyContact').value = inv["Company Contact"] || '';
          document.getElementById('companyEmail').value = inv["Company Email"] || '';
          document.getElementById('bankName').value = inv["Bank Name"] || '';
          document.getElementById('accountHolder').value = inv["Account Name"] || '';
          document.getElementById('accountNumber').value = inv["Account Number"] || '';
          document.getElementById('ifscCode').value = inv["IFSC Code"] || '';
          document.getElementById('upiID').value = inv["UPI ID"] || '';

          document.getElementById('invoiceNo').value = inv["Invoice No"] || '';
          // Format the date for the input type="date"
          document.getElementById('invoiceDate').value = formatDateToInput(inv["Invoice Date"]);
          document.getElementById('clientName').value = inv["Client Name"] || '';
          document.getElementById('clientPhone').value = inv["Client Phone"] || '';
          document.getElementById('clientAddress').value = inv["Client Address"] || '';
          document.getElementById('description').value = inv["Description"] || '';
          document.getElementById('price').value = inv["Price (Rs)"] || '';
          document.getElementById('discount').value = inv["Discount (Rs)"] || '';
          document.getElementById('advance').value = inv["Advance (Rs)"] || '';
          document.getElementById('finalPayment').value = inv["Final Payment (Rs)"] || '';
          document.getElementById('companyLogoURL').value = inv["Logo URL"] || '';

          showToast(`‚úÖ Invoice "${inv["Invoice No"]}" loaded! Click "Generate Preview" to see the details.`);
        }

        // üéØ Function to trigger PDF Download
        function downloadPDF() {
            // 1. Ensure the invoice is generated/previewed before downloading
            if (document.getElementById('invoicePreview').classList.contains('hidden')) {
                generateInvoice(); // Generate the content if not already done
            }
            
            const element = document.getElementById('invoiceContent');

            // Get current rendered dimensions (in pixels)
            const contentWidth = element.offsetWidth;
            const contentHeight = element.offsetHeight;

            const filename = `${document.getElementById('invoiceNo').value}_${document.getElementById('clientName').value.replace(/\s/g, '_')}_Invoice.pdf`;
            
            const options = {
                // Set margins to 0 for maximum use of space
                margin: [0, 0, 0, 0], 
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    // Use a slightly higher scale for better resolution on custom page sizes
                    scale: 3, 
                    logging: false, 
                    dpi: 192, 
                    letterRendering: true,
                    useCORS: true 
                },
                jsPDF: { 
                    unit: 'px', // Use pixels as the unit
                    // Define a custom format that exactly matches the content's current pixel dimensions
                    format: [contentWidth, contentHeight], 
                    orientation: 'portrait' 
                }
            };

            // 4. Generate and Save the PDF
            html2pdf().set(options).from(element).save();
            showToast("üìÑ Downloading Invoice PDF in exact preview size...");
        }


        // üõë Share functions updated to reference the new download function
        function shareWhatsApp() {
            showToast("Please use the 'Download PDF' button, then share the file via WhatsApp.", true);
        }
        function shareEmail() {
            showToast("Please use the 'Download PDF' button, then attach the file to your email.", true);
        }
        function shareNative() {
            showToast("Please use the 'Download PDF' button, then use your device's share menu.", true);
        }
    </script>

</body>
</html>